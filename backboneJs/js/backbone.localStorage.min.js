(function(a,b){if(typeof exports==="object"&&typeof require==="function"){module.exports=b(require("backbone"))}else{if(typeof define==="function"&&define.amd){define(["backbone"],function(c){return b(c||a.Backbone)})}else{b(Backbone)}}}(this,function(g){function d(){return(((1+Math.random())*65536)|0).toString(16).substring(1)}function c(){return(d()+d()+"-"+d()+"-"+d()+"-"+d()+"-"+d()+d()+d())}function b(h){return h===Object(h)}function e(k,j){var h=k.length;while(h--){if(k[h]===j){return true}}return false}function f(j,i){for(var h in i){j[h]=i[h]}return j}function a(h,j){if(h==null){return void 0}var i=h[j];return(typeof i==="function")?h[j]():i}g.LocalStorage=window.Store=function(i,j){if(!this.localStorage){throw"Backbone.localStorage: Environment does not support localStorage."}this.name=i;this.serializer=j||{serialize:function(k){return b(k)?JSON.stringify(k):k},deserialize:function(k){return k&&JSON.parse(k)}};var h=this.localStorage().getItem(this.name);this.records=(h&&h.split(","))||[]};f(g.LocalStorage.prototype,{save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(h){if(!h.id&&h.id!==0){h.id=c();h.set(h.idAttribute,h.id)}this.localStorage().setItem(this._itemName(h.id),this.serializer.serialize(h));this.records.push(h.id.toString());this.save();return this.find(h)},update:function(h){this.localStorage().setItem(this._itemName(h.id),this.serializer.serialize(h));var i=h.id.toString();if(!e(this.records,i)){this.records.push(i);this.save()}return this.find(h)},find:function(h){return this.serializer.deserialize(this.localStorage().getItem(this._itemName(h.id)))},findAll:function(){var h=[];for(var j=0,l,k;j<this.records.length;j++){l=this.records[j];k=this.serializer.deserialize(this.localStorage().getItem(this._itemName(l)));if(k!=null){h.push(k)}}return h},destroy:function(h){this.localStorage().removeItem(this._itemName(h.id));var l=h.id.toString();for(var j=0,k;j<this.records.length;j++){if(this.records[j]===l){this.records.splice(j,1)}}this.save();return h},localStorage:function(){return localStorage},_clear:function(){var j=this.localStorage(),i=new RegExp("^"+this.name+"-");j.removeItem(this.name);for(var h in j){if(i.test(h)){j.removeItem(h)}}this.records.length=0},_storageSize:function(){return this.localStorage().length},_itemName:function(h){return this.name+"-"+h}});g.LocalStorage.sync=window.Store.sync=g.localSync=function(o,l,k){var h=a(l,"localStorage")||a(l.collection,"localStorage");var n,j;var m=g.$?(g.$.Deferred&&g.$.Deferred()):(g.Deferred&&g.Deferred());try{switch(o){case"read":n=l.id!=undefined?h.find(l):h.findAll();break;case"create":n=h.create(l);break;case"update":n=h.update(l);break;case"delete":n=h.destroy(l);break}}catch(i){if(i.code===22&&h._storageSize()===0){j="Private browsing is unsupported"}else{j=i.message}}if(n){if(k&&k.success){if(g.VERSION==="0.9.10"){k.success(l,n,k)}else{k.success(n)}}if(m){m.resolve(n)}}else{j=j?j:"Record Not Found";if(k&&k.error){if(g.VERSION==="0.9.10"){k.error(l,j,k)}else{k.error(j)}}if(m){m.reject(j)}}if(k&&k.complete){k.complete(n)}return m&&m.promise()};g.ajaxSync=g.sync;g.getSyncMethod=function(i,h){var j=h&&h.ajaxSync;if(!j&&(a(i,"localStorage")||a(i.collection,"localStorage"))){return g.localSync}return g.ajaxSync};g.sync=function(j,i,h){return g.getSyncMethod(i,h).apply(this,[j,i,h])};return g.LocalStorage}));